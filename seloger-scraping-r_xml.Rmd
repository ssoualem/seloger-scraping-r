---
title: "Scraping SeLoger.com with R"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## TBD



```{r}
source("seloger_api.R")
```

## Script parameters
```{r}
# All listings for these departments will be extracted
DEPART_TO_GET <- c(92, 93, 94, 95, 91, 78, 77, 75)
```

```{r}
# Create basic directories
data_dir <- "data"
log_dir <- "log"
if(!dir.exists(data_dir)) {
  dir.create(data_dir)  
}
if(!dir.exists(log_dir)) {
  dir.create(log_dir)
}

# Load postal codes reference file (France)
# Data source : https://www.data.gouv.fr/fr/datasets/base-officielle-des-codes-postaux/
p_cd_ref <- read.csv(file.path(data_dir, "laposte_hexasmal.csv"), sep = ";")

# Get all postal codes of each department (to have many small searches instead of a big one)
for(i in 1:length(DEPART_TO_GET)) {
  pattern <- paste0("^", DEPART_TO_GET[i], "[0-9]{3}")
  postal_cd_to_get[[i]] <- p_cd_ref[grepl(pattern, p_cd_ref$Code_postal), ]$Code_postal
}
```


## Extract listings and save dataframes to files
```{r}
# Log file and data directory for the extraction
ts <- format(Sys.time(), "%Y%m%d-%H%M%S") %>% as.character()
log <- file.path(log_dir, paste0("extraction_", ts, ".log"))

extr_data_dir <- file.path(data_dir, ts)
if(!dir.exists(extr_data_dir)) {
  dir.create(extr_data_dir)
}

# Extract and save to files
sink(log)
listing_df <- vector("list", length(postal_cd_to_get) * length(SEARCH_TYPE_PARAM_VALUE))
i <- 1
for(p_cd in unlist(postal_cd_to_get)) {
  for(type in names(SEARCH_TYPE_PARAM_VALUE)) {
    print(paste("For", type, ", postal_cd =", p_cd, ":", Sys.time()))
    tmp_fname <- file.path(extr_data_dir, paste0(type, "_", p_cd, "_", ts, ".Rds"))
    listing_df[[i]] <- get_all_listing_df(p_cd, search_type = type, verbose = TRUE) %>% merge_listing_df()
    saveRDS(listing_df[[i]], tmp_fname)
    print("")
    i <- i + 1
  }
  print("")
}
print("DONE")
sink()
```


## TODO : basic sanity check (compare with manual search on the API)
```{r}
for(i in 1:length(listing_df)) {
  nrow(listing_df[[i]])
}

filter(listing_df[[1]], listing_id == 112919969) %>%
  select(party_id, listing_id, agency_id, crtn_dt, updt_dt, title, label, price, price_unit, room_nb, surf_area)

filter(listing_df[[1]], listing_id == 112919969) %>%
  select(surf_area_unit, country_id, country, postal_cd, location_insee_cd
         , city, latitude, longitude)

```



## TODO : cleanup data (NA, "", etc.)
```{r}
# Done in Tableau instead of R for pedagogical reasons

```

## TODO : move functions and constants to separate files